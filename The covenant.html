<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <link rel="icon" href="assets/engineering-helmet_18031478.png" />
  <title>نظام العهدة - تعديل حسب الطلب</title>
  <style>
@media screen and (max-width: 768px) {
  /* تحويل الشريط الجانبي (sidebar) إلى شريط أفقي أعلى */
  .sidebar {
    position: fixed;
    top: 70px;
    left: 0;
    width: 100%;
    height: auto;
    display: flex;
    overflow-x: auto;
    padding: 5px 0;
    background: #1a3b7c;
    z-index: 1000;
  }

  .sidebar ul {
    display: flex;
    flex-wrap: nowrap;
    width: 100%;
    padding: 0;
    margin: 0;
  }

  .sidebar ul li {
    display: inline-block;
    flex: 0 0 auto;
  }

  .sidebar ul li a {
    padding: 10px 15px;
    border-left: none;
    border-bottom: 3px solid transparent;
  }

  .sidebar ul li a.active,
  .sidebar ul li a:hover {
    background-color: transparent;
    border-left: none;
    border-bottom-color: #aac4ff;
  }

  /* إزالة الهامش اليمين من المحتوى الرئيسي وتعويضه بمساحة أعلى */
  main {
    margin: 0;
    margin-top: 120px; /* لتحتوي مساحة الشريط الجانبي الأفقي */
    padding: 20px 15px;
    min-height: calc(100vh - 120px);
  }

  /* تغيير تنسيق ترويسة الصفحة عند الشاشات الصغيرة */
  header {
    flex-wrap: wrap;
    padding: 15px 10px;
  }

  header nav {
    position: static;
    transform: none;
    left: auto;
    top: auto;
    margin-bottom: 10px;
    justify-content: center;
    width: 100%;
  }

  header h1 {
    font-size: 22px;
  }
}

    
 body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #e7f0ff;
      color: #0b2d70;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    header {
      background-color: #144a99;
      padding: 20px;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      user-select: none;
    }

    header nav {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      gap: 15px;
    }

    header nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s;
      cursor: pointer;
    }

    header nav a:hover {
      color: #85aaff;
    }

    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }

    .sidebar {
      width: 210px;
      background: #1a3b7c;
      color: white;
      padding-top: 30px;
      position: fixed;
      top: 70px;
      bottom: 0;
      overflow-y: auto;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar ul li {
      position: relative;
    }

    .sidebar ul li a {
      color: white;
      display: block;
      padding: 15px 25px;
      text-decoration: none;
      font-weight: 600;
      border-left: 4px solid transparent;
      transition: background-color 0.3s, border-left-color 0.3s;
      cursor: pointer;
    }

    .sidebar ul li a.active,
    .sidebar ul li a:hover {
      background-color: #2a509b;
      border-left-color: #aac4ff;
    }
    main {
      margin-right: 240px;
      padding: 20px;
    }
    .welcome {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #144a99;
      font-weight: 700;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .stats .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px #c7d0fc;
      padding: 15px 25px;
      flex: 1;
      text-align: center;
      color: #144a99;
      font-weight: 700;
    }
    form.add-form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #c3d0f6;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 25px;
      font-weight: 600;
    }
    form.add-form input,
    form.add-form select {
      flex: 1 1 180px;
      padding: 8px 12px;
      font-size: 1em;
      border: 1.8px solid #aac4ff;
      border-radius: 7px;
    }
    form.add-form button {
      background: #144a99;
      border: none;
      color: white;
      padding: 10px 18px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 7px;
      flex: 1 1 120px;
      min-width: 120px;
      transition: background 0.3s ease;
    }
    form.add-form button:hover {
      background: #0d356b;
    }
    form.add-form button.cancel {
      background: #dc3545;
      margin-left: 10px;
    }
    .table-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .table-header input[type="text"] {
      flex: 1 1 250px;
      padding: 10px;
      border-radius: 7px;
      border: 1.8px solid #aac4ff;
      font-size: 1em;
    }
    .table-header button {
      background: #144a99;
      color: white;
      border: none;
      padding: 10px 18px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 7px;
      transition: background 0.3s ease;
    }
    .table-header button:hover {
      background: #0d356b;
    }
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px #c3d0f6;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-weight: 600;
    }
    th, td {
      padding: 10px 14px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      font-size: 1em;
    }
    thead {
      background: #dbe6ff;
      color: #144a99;
    }
    
    tbody tr:hover {
      background: #f1f7ff;
    }
    .action-btn {
      padding: 6px 10px;
      margin: 0 3px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9em;
    }
    .edit-btn {
      background: #2a69d1;
      color: white;
    }
    .edit-btn:hover {
      background: #0d356b;
    }
    .delete-btn {
      background: #dc3545;
      color: white;
    }
    .delete-btn:hover {
      background: #a5221e;
    }
    footer {
      background-color: #144a99;
      color: white;
      text-align: center;
      padding: 12px 0;
      font-weight: 600
    }
    #popupMessage {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #144a99;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 0 15px #144a99aa;
      font-weight: 700;
      display: none;
      z-index: 1000;
    }
    .dropdown > a::after {
      content: " ▾";
      font-size: 14px;
      margin-left: 6px;
    }

    /* القائمة الفرعية مخفية افتراضياً */
    .submenu {
      display: none;
      list-style: none;
      padding-left: 0;
      margin: 0;
      background-color: #2a509b;
    }

    .submenu li a {
      padding: 12px 25px;
      font-weight: normal;
      border-left: 4px solid transparent;
      color: white;
      display: block;
      text-decoration: none;
      transition: background-color 0.3s, border-left-color 0.3s;
    }

    .submenu li a:hover {
      background-color: #aac4ff;
      color: #0b2d70;
      border-left-color: #0b2d70;
    }

    /* عند تفعيل القائمة الفرعية تظهر */
    .dropdown.open > .submenu {
      display: block;
    }
  </style>

  <!-- مكتبات تصدير -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <!-- Firebase (تأكد تربط حسابك الخاص) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // إعدادات Firebase الخاصة بك
const firebaseConfig = {
  apiKey: "AIzaSyAstL7SQukxHMOEshWXQEuM9Ju9n7UK8TI",
  authDomain: "lqa2ed.firebaseapp.com",
  databaseURL: "https://lqa2ed-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "lqa2ed",
  storageBucket: "lqa2ed.firebasestorage.app",
  messagingSenderId: "677918048293",
  appId: "1:677918048293:web:9644eab33e4f2df044ffcc"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let editing = false;
    let editingId = null;

    function showPopup(message) {
      const popup = document.getElementById('popupMessage');
      popup.textContent = message;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 3000);
    }

    // تحميل الإحصائيات
    function loadStats() {
      db.collection('alohda').get().then(snapshot => {
        const count = snapshot.size;
        let totalAmount = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          totalAmount += parseFloat(data.amount || 0);
        });
        document.getElementById('totalCount').textContent = count;
        document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
      }).catch(err => {
        console.error("Error loading stats:", err);
      });
    }

    // تحميل بيانات الجدول
    function loadTableData() {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';

      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();

      db.collection('alohda').orderBy('date', 'desc').get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          const id = doc.id;

          // فلترة البحث باسم السواق
          if (searchTerm && !data.carNumber.toLowerCase().includes(searchTerm)) return;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${data.date || ''}</td>
            <td>${data.driverName || ''}</td>
            <td>${data.driverPhone || ''}</td>
            <td>${data.contractorName || ''}</td>
            <td>${data.carNumber || ''}</td>
            <td>${data.deliveryMethod || ''}</td>
            <td>${data.receiptDelivered ? 'نعم' : 'لا'}</td>
            <td>${parseFloat(data.amount || 0).toFixed(2)}</td>
            <td>
              <button class="action-btn edit-btn" onclick="editRow('${id}')">تعديل</button>
              <button class="action-btn delete-btn" onclick="deleteRow('${id}')">حذف</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }).catch(err => {
        console.error("Error loading table data:", err);
      });
    }

    // تنظيف النموذج
    function clearForm() {
      document.getElementById('date').value = '';
      document.getElementById('driverName').value = '';
      document.getElementById('driverPhone').value = '';
      document.getElementById('contractorName').value = '';
      document.getElementById('carNumber').value = '';
      document.getElementById('deliveryMethod').value = 'تسليم باليد';
      document.getElementById('receiptDelivered').value = 'لا';
      document.getElementById('amount').value = '';
      editing = false;
      editingId = null;
      document.getElementById('submitBtn').textContent = 'إضافة';
    }

    // إرسال النموذج (إضافة أو تعديل)
    function submitForm() {
      const date = document.getElementById('date').value.trim();
      const driverName = document.getElementById('driverName').value.trim();
      const driverPhone = document.getElementById('driverPhone').value.trim();
      const contractorName = document.getElementById('contractorName').value.trim();
      const carNumber = document.getElementById('carNumber').value.trim();
      const deliveryMethod = document.getElementById('deliveryMethod').value;
      const receiptDelivered = document.getElementById('receiptDelivered').value === 'نعم';
      const amount = document.getElementById('amount').value.trim();

      if (!date || !driverName || !driverPhone || !contractorName || !carNumber || !amount) {
        alert('يرجى تعبئة جميع الحقول المطلوبة');
        return;
      }

      const data = {
        date,
        driverName,
        driverPhone,
        contractorName,
        carNumber,
        deliveryMethod,
        receiptDelivered,
        amount: parseFloat(amount)
      };

      if (editing) {
        db.collection('alohda').doc(editingId).update(data).then(() => {
          showPopup('تم تعديل العهدة بنجاح');
          loadTableData();
          loadStats();
          clearForm();
        }).catch(err => {
          alert('حدث خطأ أثناء التعديل');
          console.error(err);
        });
      } else {
        db.collection('alohda').add(data).then(() => {
          showPopup('تم إضافة العهدة بنجاح');
          loadTableData();
          loadStats();
          clearForm();
        }).catch(err => {
          alert('حدث خطأ أثناء الإضافة');
          console.error(err);
        });
      }
    }

    // تعديل صف
    function editRow(id) {
      db.collection('alohda').doc(id).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('date').value = data.date || '';
          document.getElementById('driverName').value = data.driverName || '';
          document.getElementById('driverPhone').value = data.driverPhone || '';
          document.getElementById('contractorName').value = data.contractorName || '';
          document.getElementById('carNumber').value = data.carNumber || '';
          document.getElementById('deliveryMethod').value = data.deliveryMethod || 'تسليم باليد';
          document.getElementById('receiptDelivered').value = data.receiptDelivered ? 'نعم' : 'لا';
          document.getElementById('amount').value = data.amount || '';
          editing = true;
          editingId = id;
          document.getElementById('submitBtn').textContent = 'حفظ التعديل';
        }
      }).catch(err => {
        alert('حدث خطأ أثناء جلب بيانات التعديل');
        console.error(err);
      });
    }

    // حذف صف
    function deleteRow(id) {
      if (confirm('هل أنت متأكد من حذف هذه العهدة؟')) {
        db.collection('alohda').doc(id).delete().then(() => {
          showPopup('تم حذف العهدة');
          loadTableData();
          loadStats();
        }).catch(err => {
          alert('حدث خطأ أثناء الحذف');
          console.error(err);
        });
      }
    }

    // تصدير Excel
    function exportToExcel() {
      const table = document.getElementById('dataTable');
      const wb = XLSX.utils.table_to_book(table, { sheet: "العهدة" });
      XLSX.writeFile(wb, 'Al-Ohda.xlsx');
    }

    // تصدير PDF
    function exportToPDF() {
      const table = document.getElementById('dataTable');
      const body = [];

      // رؤوس الأعمدة
      const headers = [];
      table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.trim());
      });
      body.push(headers);

      // محتوى الجدول
      table.querySelectorAll('tbody tr').forEach(tr => {
        const rowData = [];
        tr.querySelectorAll('td').forEach(td => {
          rowData.push(td.textContent.trim());
        });
        body.push(rowData);
      });

      const docDefinition = {
        content: [
          { text: 'بيانات العهدة', style: 'header', alignment: 'center' },
          {
            table: {
              headerRows: 1,
              widths: Array(headers.length).fill('*'),
              body: body
            },
            layout: {
              fillColor: function (rowIndex) {
                return (rowIndex === 0) ? '#dbe6ff' : null;
              }
            }
          }
        ],
        styles: {
          header: {
            fontSize: 22,
            bold: true,
            margin: [0, 0, 0, 15],
            color: '#144a99'
          }
        },
        defaultStyle: {
          font: 'Helvetica'
        }
      };

      pdfMake.createPdf(docDefinition).download('Al-Ohda.pdf');
    }

    // عند تحميل الصفحة
    window.onload = () => {
      loadTableData();
      loadStats();

      document.getElementById('searchButton').onclick = loadTableData;
      document.getElementById('exportExcel').onclick = exportToExcel;
      document.getElementById('exportPDF').onclick = exportToPDF;

      document.getElementById('searchInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          loadTableData();
        }
      });
    };

window.onload = () => {
  // ... أكواد التحميل الأخرى مثل loadTableData و loadStats

  document.querySelectorAll('.dropdown > a').forEach(dropdownToggle => {
    dropdownToggle.addEventListener('click', function(e) {
      e.preventDefault();
      const parentLi = this.parentElement;
      parentLi.classList.toggle('open');
    });
  });
};

  </script>
</head>
<body>
  <header>
         <nav>
        <a href="acc.html">حسابي</a>
        <a href="login.html" id="logoutBtn">تسجيل الخروج</a>
      </nav>
      <h1>الزامل</h1>
  </header>

  <div class="sidebar">
    <ul>
      <li><a href="index.html">الرئيسية</a></li>
      <li><a href="The covenant.html" class="active">العهدة</a></li>
    <li class="dropdown">
        <a href="#">حسابات</a>
        <ul class="submenu">
          <li><a href="insert.html">حسابات الميناء</a></li>
          <li><a href="quarry-accounts.html">حسابات المحاجر</a></li>
        </ul>
      </li>
      <li><a href="Salaries.html">المرتبات</a></li>
      <li><a href="Treasury movement.html">حركة الخزينة</a></li>
      <li><a href="settings.html">الإعدادات</a></li>
    </ul>
  </div>

  <main>
    <div class="welcome">مرحبًا بك في صفحة العهدة</div>

    <div class="stats">
      <div class="card">
        <h3>عدد العهد</h3>
        <p id="totalCount">0</p>
      </div>
      <div class="card">
        <h3>مجموع المبالغ</h3>
        <p id="totalAmount">0.00</p>
      </div>
    </div>

    <form class="add-form" onsubmit="event.preventDefault(); submitForm();">
      <input type="date" id="date" required placeholder="التاريخ" />
      <input type="text" id="driverName" required placeholder="اسم السواق" />
      <input type="tel" id="driverPhone" required placeholder="رقم تلفون السواق" pattern="[0-9]+" />
      <input type="text" id="contractorName" required placeholder="اسم المقاول" />
      <input type="text" id="carNumber" required placeholder="رقم العربية" />
      <select id="deliveryMethod" required>
        <option value="تسليم باليد">تسليم باليد</option>
        <option value="فودافون كاش">فودافون كاش</option>
        <option value="instabay">instabay</option>
      </select>
      <select id="receiptDelivered" required>
        <option value="نعم">نعم</option>
        <option value="لا" selected>لا</option>
      </select>
      <input type="number" id="amount" required min="0" step="0.01" placeholder="المبلغ" />
      <button type="submit" id="submitBtn">إضافة</button>
      <button type="button" class="cancel" onclick="clearForm()">إلغاء</button>
    </form>

    <div class="table-header">
      <input type="text" id="searchInput" placeholder="بحث برقم العربية ..." />
      <button id="searchButton">بحث</button>
      <button id="exportExcel">تصدير Excel</button>
      <button id="exportPDF">تصدير PDF</button>
    </div>

    <div class="table-container">
      <table id="dataTable" dir="rtl">
        <thead>
          <tr>
            <th>التاريخ</th>
            <th>اسم السواق</th>
            <th>رقم تلفون السواق</th>
            <th>اسم المقاول</th>
            <th>رقم العربية</th>
            <th>طريقة التسليم</th>
            <th>تم تسليم إيصال</th>
            <th>المبلغ</th>
            <th>العمليات</th>
          </tr>
        </thead>
        <tbody>
          <!-- البيانات تظهر هنا -->
        </tbody>
      </table>
    </div>
  </main>

  <footer>
    &copy; 2025 جميع الحقوق محفوظة
  </footer>

  <div id="popupMessage"></div>
</body>
</html>
